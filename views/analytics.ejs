<%- include('partials/header'); -%>

<div class="container mt-4 position-relative z-index-1">
    <div class="pb-3 mb-3 d-flex border-bottom">
        <h4 class="m-0 p-0 me-1">
            Analytics
          </h4>
        <h5 class="m-0 p-0"> (<%= usersCount %>) </h5>
        <style>
            .table tbody tr {
                user-select: none; /* Disable text selection on table rows */
            }
        </style>
        <h3>
            <button id="downloadButton" class="btn btn-primary">Download Data</button>

<script>
    const downloadButton = document.getElementById('downloadButton');
    downloadButton.addEventListener('mousedown', (event) => {
        event.preventDefault(); // Prevent the default button behavior

        // Get the table rows
// Get the table rows
const tableRows = document.querySelectorAll('.table tbody tr:not(.chart-container)');
        // Generate the CSV data
        const data = [["Username", "Total Photos", "Total Hashtags", "Total Worth", "Hashtags per Photo"]];
        tableRows.forEach(row => {
            const username = row.querySelector('td:nth-child(2)').textContent;
            const totalPhotos = row.querySelector('td:nth-child(3)').textContent;
            const totalHashtags = row.querySelector('td:nth-child(4)').textContent;
            const totalWorth = row.querySelector('td:nth-child(5)').textContent;
            const hashtagsPerPhoto = (parseFloat(totalHashtags) / parseFloat(totalPhotos)).toFixed(2);
            data.push([username, totalPhotos, totalHashtags, totalWorth, hashtagsPerPhoto]);
        });
        
        const csvContent = "data:text/csv;charset=utf-8," + data.map(row => row.join(",")).join("\n");

        // Create a temporary anchor element and download the CSV file
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
</script>
        </h3>
    </div>
    <div class="border rounded p-3">
        <div class="table-responsive">
            <table class="table table-striped table-hover position-relative z-index-0">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Username</th>
                        <th scope="col">Total Photos</th>
                        <th scope="col">Total Hashtags</th>
                        <th scope="col">Total Worth</th>
                        <th scope="col">AvgHash/Photo</th>
                    </tr>
                </thead>
                <tbody>
                    <% for (let data of datas) { %>
                    <tr>
                        <th scope="row">
                            <a href="" class="stretched-link text-decoration-none text-dark fw-bold"><%= data.id %></a>
                        </th>
                        <td><%= data.user %></td>
                        <td><%= data.imageCount %></td>
                        <td><%= data.hashtagsCount %></td>
                        <td><%= data.totalSp %></td>
                        <td><%= (data.hashtagsCount)/(data.imageCount) %></td>
                    </tr>
                    <% } %>
                </tbody>
            </table>
<!-- admin/adminDashboard.ejs -->

<!-- Chart controls -->
<div class="mb-2">
    <label for="chartType" class="form-label">Chart Type</label>
    <select id="chartType" class="form-select form-select-sm w-auto d-inline-block">
        <option value="bar">Bar</option>
        <option value="line">Line</option>
        <option value="pie">Pie</option>
    </select>
    <input type="date" id="startDate" class="form-control form-control-sm d-inline-block w-auto ms-2" />
    <input type="date" id="endDate" class="form-control form-control-sm d-inline-block w-auto ms-2" />
    <button id="applyRange" class="btn btn-sm btn-primary ms-2">Apply</button>
</div>
<div class="chart-container">
    <canvas id="chartContainer"></canvas>
</div>
            
        </div>
    </div>
</div>

<%- include('partials/footer'); -%>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.photoData = <%- JSON.stringify(photos) %>;
</script>
<script src="/analyticsChart.js"></script>
